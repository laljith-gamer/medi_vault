<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediVault - Secure Healthcare Records Management</title>
    <meta name="description" content="Secure medical records management system for hospitals. ABDM compliant, FHIR R4 compatible healthcare data management.">
    <link rel="stylesheet" href="styles.css">
    
    <!-- FIXED: Multiple CDN options with fallback -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js" 
            onerror="loadSupabaseBackup()"></script>
    
    <!-- Backup CDN loader -->
    <script>
        function loadSupabaseBackup() {
            console.warn("‚ö†Ô∏è jsDelivr CDN failed, trying unpkg backup...");
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/@supabase/supabase-js@2';
            script.onerror = () => {
                console.error("‚ùå All CDN sources failed!");
                alert("Failed to load required libraries. Please check your internet connection.");
            };
            document.head.appendChild(script);
        }
    </script>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loader"></div>
        <p>Initializing secure connection...</p>
    </div>

    <!-- Connection Status Indicator -->
    <div class="connection-status hidden" id="connectionStatus">
        <span id="statusMessage">Connecting...</span>
    </div>

    <!-- Initial Registration Form -->
    <section class="auth-section" id="initialRegistration">
        <div class="auth-container">
            <div class="auth-header">
                <h1>üè• MediVault</h1>
                <p class="subtitle">Join our secure medical records network</p>
                <p class="info-text">Verify your hospital credentials to begin registration</p>
            </div>
            
            <div id="verificationForm">
                <div class="form-group">
                    <label for="hospitalName">Hospital Name *</label>
                    <input type="text" id="hospitalName" placeholder="e.g., AIIMS New Delhi" required>
                </div>

                <div class="form-group">
                    <label for="hospitalId">Hospital ID *</label>
                    <input type="text" id="hospitalId" placeholder="e.g., AIIMS-DEL-001" required>
                </div>

                <div class="form-group">
                    <label for="licenseNumber">License Number *</label>
                    <input type="text" id="licenseNumber" placeholder="e.g., DL/MED/2023/001" required>
                </div>

                <button type="button" id="verifyBtn" class="btn btn-primary">
                    Verify Hospital
                </button>

                <p class="text-center mt-4">
                    Already have an account? 
                    <a href="#" onclick="showLogin()">Sign in here</a>
                </p>
            </div>

            <!-- Registration Form (Hidden Until Verified) -->
            <form id="registrationForm" class="hidden">
                <div class="success-message mb-4">
                    ‚úÖ Hospital verified successfully! Complete your admin account setup.
                </div>

                <div class="form-group">
                    <label for="adminName">Admin Name *</label>
                    <input type="text" id="adminName" placeholder="Enter admin name" required>
                </div>

                <div class="form-group">
                    <label for="adminEmail">Admin Email *</label>
                    <input type="email" id="adminEmail" placeholder="admin@hospital.com" required>
                </div>

                <div class="form-group">
                    <label for="adminPhone">Admin Phone *</label>
                    <input type="tel" id="adminPhone" placeholder="+91 XXXXXXXXXX" required>
                </div>

                <!-- FIXED: Password Field with Toggle -->
                <div class="form-group">
                    <label for="password">Password *</label>
                    <div class="password-input">
                        <input type="password" id="password" placeholder="Create a strong password" required>
                        <button type="button" class="toggle-password" id="togglePassword" aria-label="Toggle password visibility">
                            üëÅÔ∏è
                        </button>
                    </div>
                    <small>Min 8 characters, include uppercase, lowercase, number & special character</small>
                    <div class="password-strength" id="passwordStrength"></div>
                </div>

                <!-- FIXED: Confirm Password Field with Toggle -->
                <div class="form-group">
                    <label for="confirmPassword">Confirm Password *</label>
                    <div class="password-input">
                        <input type="password" id="confirmPassword" placeholder="Re-enter your password" required>
                        <button type="button" class="toggle-password" id="toggleConfirmPassword" aria-label="Toggle confirm password visibility">
                            üëÅÔ∏è
                        </button>
                    </div>
                    <div class="password-match" id="passwordMatch"></div>
                </div>

                <button type="submit" class="btn btn-primary">
                    Create Admin Account
                </button>
            </form>
        </div>
    </section>

    <!-- Login Section -->
    <section class="auth-section hidden" id="loginSection">
        <div class="auth-container">
            <div class="auth-header">
                <h1>üè• MediVault</h1>
                <p class="subtitle">Sign in to your hospital dashboard</p>
            </div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">Email *</label>
                    <input type="email" id="loginEmail" placeholder="admin@hospital.com" required>
                </div>

                <!-- FIXED: Login Password Field with Toggle -->
                <div class="form-group">
                    <label for="loginPassword">Password *</label>
                    <div class="password-input">
                        <input type="password" id="loginPassword" placeholder="Enter your password" required>
                        <button type="button" class="toggle-password" id="toggleLoginPassword" aria-label="Toggle login password visibility">
                            üëÅÔ∏è
                        </button>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary">Sign In</button>
                
                <p class="text-center mt-4">
                    Don't have an account? 
                    <a href="#" onclick="showRegistration()">Register here</a>
                </p>
            </form>
        </div>
    </section>

    <!-- Dashboard Section -->
    <section class="dashboard-section hidden" id="dashboardSection">
        <nav class="navbar">
            <div class="navbar-brand">
                <h2>üè• MediVault</h2>
            </div>
            <div class="navbar-menu">
                <span id="hospitalNameDisplay"></span>
                <button class="btn btn-secondary" onclick="logout()">Logout</button>
            </div>
        </nav>

        <div class="dashboard-container">
            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üìä</div>
                    <div class="stat-info">
                        <h3>Total Medical Records</h3>
                        <p class="stat-number" id="totalRecords">0</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚úÖ</div>
                    <div class="stat-info">
                        <h3>Active Records</h3>
                        <p class="stat-number" id="activeRecords">0</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üë•</div>
                    <div class="stat-info">
                        <h3>Total Patients</h3>
                        <p class="stat-number" id="totalPatients">0</p>
                    </div>
                </div>
            </div>

            <!-- Activity Feed -->
            <div class="activity-section">
                <h3>Recent Activity</h3>
                <div class="activity-feed" id="activityFeed">
                    <p class="text-muted">Recent activities will appear here</p>
                </div>
            </div>

            <!-- Add Medical Record Form -->
            <div class="form-section">
                <h3>Add New Medical Record</h3>
                <p class="info-text">Enter patient details to verify and add medical record</p>
                
                <form id="addRecordForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="patientId">Patient ID *</label>
                            <input type="text" id="patientId" placeholder="Enter patient ID" required>
                        </div>
                        <div class="form-group">
                            <label for="patientPhone">Patient Phone *</label>
                            <input type="tel" id="patientPhone" placeholder="+91 XXXXXXXXXX" required>
                        </div>
                    </div>

                    <button type="button" id="verifyPatientBtn" class="btn btn-secondary">
                        Verify Patient
                    </button>

                    <div id="recordDetails" class="hidden">
                        <div class="success-message mb-4">
                            ‚úÖ Patient verified! Add medical record details.
                        </div>

                        <div class="form-group">
                            <label for="diagnosis">Diagnosis *</label>
                            <textarea id="diagnosis" rows="3" placeholder="Enter diagnosis" required></textarea>
                        </div>

                        <div class="form-group">
                            <label for="treatment">Treatment *</label>
                            <textarea id="treatment" rows="3" placeholder="Enter treatment details" required></textarea>
                        </div>

                        <div class="form-group">
                            <label for="medications">Medications</label>
                            <textarea id="medications" rows="2" placeholder="List medications"></textarea>
                        </div>

                        <div class="form-group">
                            <label for="notes">Additional Notes</label>
                            <textarea id="notes" rows="2" placeholder="Any additional information"></textarea>
                        </div>

                        <button type="submit" class="btn btn-primary">
                            Add Medical Record
                        </button>
                    </div>
                </form>
            </div>

            <!-- View Records Section -->
            <div class="records-section">
                <h3>View Patient Records</h3>
                <p class="info-text">Enter Patient ID and Phone Number to verify</p>
                
                <div class="verify-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="viewPatientId">Patient ID *</label>
                            <input type="text" id="viewPatientId" placeholder="Enter patient ID">
                        </div>
                        <div class="form-group">
                            <label for="viewPatientPhone">Patient Phone *</label>
                            <input type="tel" id="viewPatientPhone" placeholder="+91 XXXXXXXXXX">
                        </div>
                    </div>
                    <button type="button" id="viewRecordsBtn" class="btn btn-secondary">
                        View Records
                    </button>
                </div>

                <div id="recordsDisplay" class="records-display">
                    <p class="text-muted">Medical records will appear here once created</p>
                </div>
            </div>
        </div>
    </section>

    <script src="app.js"></script>
</body>
</html>
